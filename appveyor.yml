#---------------------------------#
#      general configuration      #
#---------------------------------#

version: 0.9.{build}

branches:
  except:
    - gh-pages

# Maximum number of concurrent jobs for the project
max_jobs: 1

#---------------------------------#
#    environment configuration    #
#---------------------------------#

clone_folder: c:\projects\RacingToHell

#---------------------------------#
#       build configuration       #
#---------------------------------#

# build platform, i.e. x86, x64, Any CPU. This setting is optional.
platform: Any CPU

# build Configuration, i.e. Debug, Release, etc.
configuration: Debug

# to run your custom scripts instead of automatic MSBuild
build_script:
  #  Fetch mingw64
  - ps: $uri = 'https://objects.githubusercontent.com/github-production-release-asset-2e65be/112254496/c32d78d8-21e5-457f-9b6b-1425bedd6b71?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAIWNJYAX4CSVEH53A%2F20220217%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20220217T230408Z&X-Amz-Expires=300&X-Amz-Signature=c2e6f2ac44a2ae36f9694958f5ffdcb840d1743a186b180c8b1cd15dce3269b6&X-Amz-SignedHeaders=host&actor_id=1887241&key_id=0&repo_id=112254496&response-content-disposition=attachment%3B%20filename%3Dllvm-mingw-20211002-msvcrt-x86_64.zip&response-content-type=application%2Foctet-stream'
  - ps: Invoke-WebRequest -Uri $uri -OutFile mingw.zip -UserAgent [Microsoft.PowerShell.Commands.PSUserAgent]::Chrome
  - 7z x mingw.zip -aoa

  # Create build directory
  - mkdir build
  - cd build

  #  Set up environment
  - set CC=C:/projects/pdf-editor/llvm-mingw-20211002-msvcrt-x86_64/bin/gcc
  - set CXX=C:/projects/pdf-editor/llvm-mingw-20211002-msvcrt-x86_64/bin/g++
  - set CMAKE_C_COMPILER=C:/projects/pdf-editor/llvm-mingw-20211002-msvcrt-x86_64/bin/clang
  - set CMAKE_CXX_COMPILER=C:/projects/pdf-editor/llvm-mingw-20211002-msvcrt-x86_64/bin/clang
  - set OLD_PATH=%PATH%
  - set PATH=C:/projects/pdf-editor/llvm-mingw-20211002-msvcrt-x86_64/bin;"C:/Program Files (x86)/CMake/bin";"C:/Program Files/Git/bin"

  #  Generate build files
  - cmake -G "Ninja" ../

  #  Build
  - cmake .. -G Ninja -D CMAKE_BUILD_TYPE=Release
  - cmake --build .

  # Test
#  - ctest --output-on-failure
#  - cmake --build . --target test_files
#  - cmake --build . --target test_suite_verapdf
#  - cmake --build . --target test_suite_isartor
#  - cmake --build . --target test_suite_bfosupport

  # Package
  - cmake --build . --target package
  - cmake --build . --target package_source

  #  Reset environment for after_build
  - set PATH=%OLD_PATH%
  - cd ..

#---------------------------------#
#       tests configuration       #
#---------------------------------#
test: false

#---------------------------------#
#      artifacts configuration    #
#---------------------------------#
artifacts:
  - path: build/PDF-Editor-1.0.0-win64.exe

#---------------------------------#
#     deployment configuration    #
#---------------------------------#
#deploy:
#  - provider: GitHub
#    artifact: RacingToHellWindows.zip
#    draft: false
#    prerelease: false
#    on:
#      appveyor_repo_tag: true
